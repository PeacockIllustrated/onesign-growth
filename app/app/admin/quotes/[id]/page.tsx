import { requireAdmin } from '@/lib/auth';
import { createServerClient } from '@/lib/supabase-server';
import { PageHeader, Card, Chip } from '../../../components/ui';
import { notFound } from 'next/navigation';
import { getRateCardForPricingSet } from '@/lib/quoter/rate-card';
import { QuoteDetailClient } from './QuoteDetailClient';
import { Quote, QuoteItem, PanelLettersV1Input } from '@/lib/quoter/types';
import { hasOverrides } from '@/lib/quoter/utils';
import Link from 'next/link';
import { ArrowLeft, Printer, Copy, AlertTriangle } from 'lucide-react';
import { DuplicateQuoteButton } from './DuplicateQuoteButton';

interface PageProps {
    params: Promise<{ id: string }>;
}

function formatDate(dateStr: string): string {
    return new Date(dateStr).toLocaleDateString('en-GB', {
        day: '2-digit',
        month: 'short',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
    });
}

function formatPence(pence: number): string {
    return `£${(pence / 100).toFixed(2)}`;
}

function getStatusVariant(status: string): 'draft' | 'review' | 'approved' | 'done' | 'default' {
    switch (status) {
        case 'draft': return 'draft';
        case 'sent': return 'review';
        case 'accepted': return 'approved';
        case 'rejected': return 'default';
        case 'expired': return 'default';
        default: return 'default';
    }
}

export default async function QuoteDetailPage({ params }: PageProps) {
    await requireAdmin();

    const { id } = await params;
    const supabase = await createServerClient();

    // Fetch quote with items
    const { data: quote, error: quoteError } = await supabase
        .from('quotes')
        .select('*')
        .eq('id', id)
        .single();

    if (quoteError || !quote) {
        notFound();
    }

    const { data: items } = await supabase
        .from('quote_items')
        .select('*')
        .eq('quote_id', id)
        .order('created_at', { ascending: true });

    // Get rate card for this quote's pricing set
    const rateCard = await getRateCardForPricingSet(quote.pricing_set_id);

    // Prepare simplified rate card data for client component
    const panelMaterials = Array.from(rateCard.panelPriceByMaterialAndSize.keys())
        .map(key => key.split('::')[0])
        .filter((v, i, a) => a.indexOf(v) === i);

    const panelFinishes = Array.from(rateCard.finishCostPerM2ByFinish.keys());

    const finishRulesByType: Record<string, string[]> = {};
    for (const [type, finishes] of rateCard.finishRulesByType) {
        finishRulesByType[type] = Array.from(finishes);
    }

    const quoteData = quote as Quote;
    const itemsData = (items || []) as QuoteItem[];
    const totalPence = itemsData.reduce((sum, item) => sum + (item.line_total_pence || 0), 0);

    return (
        <div>
            <div className="mb-4">
                <Link
                    href="/app/admin/quotes"
                    className="text-sm text-neutral-500 hover:text-neutral-900 flex items-center gap-1"
                >
                    <ArrowLeft size={14} />
                    Back to Quotes
                </Link>
            </div>

            <PageHeader
                title={quoteData.quote_number}
                description={quoteData.customer_name || 'No customer name'}
                action={
                    <div className="flex items-center gap-3">
                        <DuplicateQuoteButton quoteId={id} />
                        <Link
                            href={`/app/admin/quotes/${id}/print`}
                            target="_blank"
                            className="flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-neutral-600 bg-neutral-100 hover:bg-neutral-200 rounded-[var(--radius-sm)] transition-colors"
                        >
                            <Printer size={14} />
                            Print / PDF
                        </Link>
                        <Chip variant={getStatusVariant(quoteData.status)}>
                            {quoteData.status}
                        </Chip>
                    </div>
                }
            />

            {/* Quote Info */}
            <Card className="mb-6">
                <div className="grid grid-cols-5 gap-6">
                    <div>
                        <p className="text-xs font-medium text-neutral-500 uppercase mb-1">Customer</p>
                        <p className="text-sm text-neutral-900">{quoteData.customer_name || '—'}</p>
                    </div>
                    <div>
                        <p className="text-xs font-medium text-neutral-500 uppercase mb-1">Email</p>
                        <p className="text-sm text-neutral-900">{quoteData.customer_email || '—'}</p>
                    </div>
                    <div>
                        <p className="text-xs font-medium text-neutral-500 uppercase mb-1">Phone</p>
                        <p className="text-sm text-neutral-900">{quoteData.customer_phone || '—'}</p>
                    </div>
                    <div>
                        <p className="text-xs font-medium text-neutral-500 uppercase mb-1">Created</p>
                        <p className="text-sm text-neutral-900">{formatDate(quoteData.created_at)}</p>
                    </div>
                    <div>
                        <p className="text-xs font-medium text-neutral-500 uppercase mb-1">Updated</p>
                        <p className="text-sm text-neutral-900">{formatDate(quoteData.updated_at)}</p>
                    </div>
                </div>
            </Card>

            {/* Line Items */}
            <Card className="mb-6">
                <div className="flex items-center justify-between mb-4">
                    <h2 className="text-sm font-semibold text-neutral-900">Line Items</h2>
                    <div className="text-sm">
                        <span className="text-neutral-500">Total: </span>
                        <span className="font-bold text-lg">{formatPence(totalPence)}</span>
                    </div>
                </div>

                {itemsData.length === 0 ? (
                    <p className="text-sm text-neutral-500 py-4 text-center">
                        No line items yet. Add one below.
                    </p>
                ) : (
                    <div className="space-y-3">
                        {itemsData.map((item, index) => {
                            const input = item.input_json as PanelLettersV1Input;
                            const output = item.output_json as {
                                derived?: { panels_needed?: number; area_m2?: number };
                                letter_sets_breakdown?: { qty: number; type: string }[];
                            };
                            const itemHasOverrides = hasOverrides(input);

                            return (
                                <div
                                    key={item.id}
                                    className={`p-4 rounded-[var(--radius-sm)] border ${itemHasOverrides
                                        ? 'bg-amber-50 border-amber-200'
                                        : 'bg-neutral-50 border-neutral-200'
                                        }`}
                                >
                                    <div className="flex items-start justify-between">
                                        <div>
                                            <div className="flex items-center gap-2">
                                                <p className="text-sm font-medium text-neutral-900">
                                                    Item {index + 1}: {item.item_type === 'panel_letters_v1' ? 'Panel + Letters' : item.item_type}
                                                </p>
                                                {itemHasOverrides && (
                                                    <span className="inline-flex items-center gap-1 px-2 py-0.5 text-xs font-medium bg-amber-100 text-amber-800 rounded">
                                                        <AlertTriangle size={10} />
                                                        Override
                                                    </span>
                                                )}
                                            </div>
                                            <p className="text-xs text-neutral-500 mt-1">
                                                {output.derived?.panels_needed || 0} panels • {output.derived?.area_m2?.toFixed(2) || 0} m² • {output.letter_sets_breakdown?.reduce((sum, s) => sum + s.qty, 0) || 0} letters
                                            </p>
                                        </div>
                                        <div className="text-right">
                                            <p className="text-sm font-bold text-neutral-900">
                                                {formatPence(item.line_total_pence)}
                                            </p>
                                            <QuoteDetailClient
                                                quoteId={id}
                                                itemId={item.id}
                                                mode="item-actions"
                                                pricingSetId={quote.pricing_set_id}
                                                rateCard={{ panelMaterials, panelFinishes, finishRulesByType }}
                                            />
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                )}
            </Card>

            {/* Add Line Item Form */}
            <QuoteDetailClient
                quoteId={id}
                pricingSetId={quote.pricing_set_id}
                rateCard={{
                    panelMaterials,
                    panelFinishes,
                    finishRulesByType,
                }}
            />
        </div>
    );
}
